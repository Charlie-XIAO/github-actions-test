name: pr-update-lock-files-command
on:
  issue_comment:
    types: [created]

permissions:
  contents: write

jobs:
  update-lock-files:
    if: >-
      github.event.issue.pull_request
      && startsWith(github.event.comment.body, '@scikit-learn-bot update lock-files')
    runs-on: ubuntu-latest

    steps:
      - name: Get PR HEAD information
        id: pr-head-info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_info=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json headRefName,headRepository,headRepositoryOwner)
          pr_head_ref=$(echo "$pr_info" | jq -r '.headRefName')
          pr_head_repository=$(echo "$pr_info" | jq -r '.headRepositoryOwner.login + "/" + .headRepository.name')
          echo "pr_head_ref=$pr_head_ref" >> $GITHUB_OUTPUT
          echo "pr_head_repository=$pr_head_repository" >> $GITHUB_OUTPUT

      - name: Check out the code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-head-info.outputs.pr_head_ref }}
          repository: ${{ steps.pr-head-info.outputs.pr_head_repository }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Update lock files
        env:
          COMMENT: ${{ github.event.comment.body }}
        run: |
          pip install click
          python build_tools/pr_update_lock_files.py
          echo "I'm doing something malicious in the workflow file..."
